---
description: Правила для пакета neuroline-nestjs
globs: packages/neuroline-nestjs/**/*
---

# Пакет: neuroline-nestjs

## Назначение

NestJS интеграция: фабрика контроллера для конкретного pipeline + сервис для доступа к `PipelineManager`/`PipelineStorage`.

## Структура

```
src/
├── index.ts              # Публичные экспорты
├── constants.ts          # Injection tokens
├── dto.ts                # DTO классы для валидации
└── neuroline.service.ts  # Бизнес-логика
└── pipeline-controller.factory.ts # createPipelineController factory
```

## Соглашения NestJS

- Следуй NestJS conventions (Module, Controller, Service)
- Используй декораторы для DI (`@Injectable`, `@Controller`, etc.)
- DTO классы для валидации входных данных
- Swagger декораторы для документации API

## Использование

```typescript
import { Module } from '@nestjs/common';
import { PipelineManager, InMemoryPipelineStorage } from 'neuroline';
import { createPipelineController } from 'neuroline-nestjs';
import { demoPipeline } from './pipelines';

const storage = new InMemoryPipelineStorage();
const manager = new PipelineManager({ storage });

const DemoPipelineController = createPipelineController({
	path: 'api/pipeline/demo',
	manager,
	storage,
	pipeline: demoPipeline, // один контроллер = один pipeline
});

@Module({
	controllers: [DemoPipelineController],
})
export class AppModule {}
```

## REST API Endpoints

API совместим с `neuroline/client` (query-параметр `action`):

| Method | Path | Описание |
|--------|------|----------|
| POST | `/<path>` | Запуск pipeline |
| GET | `/<path>?action=status&id=<id>` | Статус pipeline |
| GET | `/<path>?action=result&id=<id>[&jobName=<job>]` | Результат (артефакт) одной job |
| GET | `/<path>?action=list&page=1&limit=10` | Список pipelines (по типу контроллера) |

### Debug-эндпоинты (требуют `enableDebugEndpoints: true`)

⚠️ **Отключены по умолчанию** — возвращают чувствительные данные (input, options, artifacts).

| Method | Path | Описание |
|--------|------|----------|
| GET | `/<path>?action=job&id=<id>&jobName=<job>` | Данные job (input/options/artifact) |
| GET | `/<path>?action=pipeline&id=<id>` | Полное состояние pipeline |

```typescript
const DemoController = createPipelineController({
	path: 'api/pipeline/demo',
	manager,
	storage,
	pipeline: demoPipeline,
	enableDebugEndpoints: process.env.NODE_ENV === 'development', // только для dev
});
```

## Правила

1. **Injection tokens** в `constants.ts`
2. **DTO** для всех входных данных контроллера
3. **Service** инкапсулирует логику работы с PipelineManager
4. **Controller** только маршрутизация и валидация
