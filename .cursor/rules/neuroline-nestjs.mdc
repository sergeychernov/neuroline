---
description: Правила для пакета neuroline-nestjs
globs: packages/neuroline-nestjs/**/*
---

# Пакет: neuroline-nestjs

## Назначение

NestJS интеграция: динамический модуль для pipeline контроллеров с поддержкой DI.

## Структура

```
src/
├── index.ts              # Публичные экспорты
├── constants.ts          # Injection tokens
├── dto.ts                # DTO классы для валидации
├── neuroline.module.ts   # NeurolineModule с forRootAsync()
└── neuroline.service.ts  # Сервис для доступа к manager/storage
```

## Рекомендуемый способ: NeurolineModule.forRootAsync()

```typescript
import { Module } from '@nestjs/common';
import { MongooseModule, getModelToken } from '@nestjs/mongoose';
import { 
  NeurolineModule, 
  MongoPipelineStorage, 
  PipelineSchema 
} from 'neuroline-nestjs';
import { demoPipelineConfig } from './pipelines';
import { AuthGuard } from './guards';

@Module({
  imports: [
    MongooseModule.forFeature([{ name: 'Pipeline', schema: PipelineSchema }]),
    
    NeurolineModule.forRootAsync({
      imports: [MongooseModule],
      useFactory: (model) => new MongoPipelineStorage(model),
      inject: [getModelToken('Pipeline')],
      controllers: [
        {
          path: 'api/v1/demo-pipeline',
          pipeline: demoPipelineConfig,
          guards: [AuthGuard],       // guards для всего контроллера
          adminGuards: [AdminGuard], // guards для admin-эндпоинтов
          // Асинхронное получение jobOptions (для базового POST)
          getJobOptions: async (input, request) => {
            const user = request.user;
            return {
              myJob: { userId: user.id, apiKey: process.env.API_KEY },
            };
          },
        },
      ],
      // Фоновый watchdog для "зависших" джоб
      staleJobsWatchdog: {
        checkIntervalMs: 60_000,   // проверка раз в минуту
        jobTimeoutMs: 1200_000,    // таймаут 20 минут
      },
    }),
  ],
})
export class AppModule {}
```

## DI токены

- `NEUROLINE_MANAGER` — PipelineManager
- `NEUROLINE_STORAGE` — PipelineStorage
- `NeurolineService` — сервис-обёртка

```typescript
import { Injectable, Inject } from '@nestjs/common';
import { NEUROLINE_MANAGER, NeurolineService } from 'neuroline-nestjs';
import type { PipelineManager } from 'neuroline';

@Injectable()
export class MyService {
  constructor(
    // Вариант 1: через сервис
    private readonly neuroline: NeurolineService,
    // Вариант 2: напрямую
    @Inject(NEUROLINE_MANAGER) private readonly manager: PipelineManager,
  ) {}
}
```

## REST API Endpoints

API совместим с `neuroline/client` (query-параметр `action`):

| Method | Path | Body | Описание |
|--------|------|------|----------|
| POST | `/<path>` | `TInput` | Запуск pipeline (jobOptions через getJobOptions) |
| GET | `/<path>?action=status&id=<id>` | — | Статус pipeline |
| GET | `/<path>?action=result&id=<id>[&jobName=<job>]` | — | Результат (артефакт) одной job |
| GET | `/<path>?action=list&page=1&limit=10` | — | Список pipelines (по типу контроллера) |

### Admin-эндпоинты (требуют `adminGuards`)

⚠️ **Отключены по умолчанию** — возвращают чувствительные данные или позволяют передавать jobOptions напрямую.

| Method | Path | Body | Описание |
|--------|------|------|----------|
| POST | `/<path>?action=startWithOptions` | `{ input, jobOptions }` | Запуск с явными jobOptions |
| POST | `/<path>?action=retry&id=<id>` | `{ jobName, jobOptions? }` | Перезапуск pipeline с указанной job |
| GET | `/<path>?action=job&id=<id>&jobName=<job>` | — | Данные job (input/options/artifact) |
| GET | `/<path>?action=pipeline&id=<id>` | — | Полное состояние pipeline |

## Опции NeurolineModuleAsyncOptions

| Опция | Описание |
|-------|----------|
| `useFactory` | Factory для создания PipelineStorage |
| `inject` | Провайдеры для инъекции в factory |
| `controllers` | Массив конфигураций контроллеров |
| `logger` | Логгер для PipelineManager |
| `staleJobsWatchdog` | Опции для фонового watchdog зависших джоб |

### PipelineControllerOptions

| Опция | Описание |
|-------|----------|
| `path` | Путь контроллера (например, `api/v1/demo-pipeline`) |
| `pipeline` | Конфигурация pipeline |
| `guards` | Guards для всего контроллера |
| `adminGuards` | Guards для admin-эндпоинтов (если не указаны — admin отключен) |
| `getJobOptions` | Функция `(input, request) => jobOptions` для базового POST |

### staleJobsWatchdog

```typescript
staleJobsWatchdog: {
    checkIntervalMs: 60_000,   // интервал проверки (по умолчанию 1 мин)
    jobTimeoutMs: 1200_000,    // таймаут джобы (по умолчанию 20 мин)
    onStaleJobsFound: (count) => { ... },  // callback при обнаружении
}
```

Watchdog автоматически запускается при старте модуля и останавливается при shutdown.

## Правила

1. **Injection tokens** в `constants.ts`
2. **DTO** для всех входных данных контроллера
3. **NeurolineModule** предпочтительнее legacy factory
4. **Guards** передаются через опции контроллера, не декораторы
