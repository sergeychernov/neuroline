---
description: Правила для пакета neuroline-nextjs
globs: packages/neuroline-nextjs/**/*
---

# Пакет: neuroline-nextjs

## Назначение

Next.js App Router интеграция: route handlers для API routes.

## Структура

```
src/
├── index.ts          # Публичные экспорты
├── types.ts          # Типы для handlers
├── handlers.ts       # Функции-обработчики
└── route-handler.ts  # createPipelineRouteHandler factory
```

## Использование

```typescript
// app/api/pipeline/demo/route.ts
import { createPipelineRouteHandler } from 'neuroline-nextjs';
import { manager, storage } from '@/lib/neuroline';
import { demoPipeline } from '@/pipelines';

const handlers = createPipelineRouteHandler({
	manager,
	storage,
	pipeline: demoPipeline, // один route = один pipeline
	// Асинхронное получение jobOptions для базового POST
	getJobOptions: async (input, request) => {
		const authHeader = request.headers.get('Authorization');
		return {
			myJob: { token: authHeader, apiKey: process.env.API_KEY },
		};
	},
});

export const POST = handlers.POST;
export const GET = handlers.GET;
```

## Соглашения Next.js App Router

- Используй Web Fetch API типы `Request` / `Response` (совместимо с App Router)
- Route handlers экспортируют именованные функции (`GET`, `POST`)
- Динамические сегменты через `[param]` или `[...path]`

## API Routes

Один route обслуживает один pipeline, поэтому `pipelineType` берётся из конфигурации route.

| Method | Path | Body | Описание |
|--------|------|------|----------|
| POST | `/api/pipeline/<pipeline>` | `TInput` | Запуск pipeline (jobOptions через getJobOptions) |
| GET | `/api/pipeline/<pipeline>?action=status&id=<id>` | — | Статус pipeline |
| GET | `/api/pipeline/<pipeline>?action=result&id=<id>[&jobName=<job>]` | — | Результат (артефакт) одной job |
| GET | `/api/pipeline/<pipeline>?action=list&page=1&limit=10` | — | Список pipeline этого типа |

### Admin-эндпоинты (требуют `enableDebugEndpoints: true`)

⚠️ **Отключены по умолчанию** — возвращают чувствительные данные или позволяют передавать jobOptions напрямую.

| Method | Path | Body | Описание |
|--------|------|------|----------|
| POST | `/api/pipeline/<pipeline>?action=startWithOptions` | `{ input, jobOptions }` | Запуск с явными jobOptions |
| POST | `/api/pipeline/<pipeline>?action=retry&id=<id>` | `{ jobName, jobOptions? }` | Перезапуск pipeline с указанной job |
| GET | `/api/pipeline/<pipeline>?action=job&id=<id>&jobName=<job>` | — | Данные job (input/options/artifact) |
| GET | `/api/pipeline/<pipeline>?action=pipeline&id=<id>` | — | Полные данные pipeline |

```typescript
const handlers = createPipelineRouteHandler({
	manager,
	storage,
	pipeline: demoPipeline,
	enableDebugEndpoints: process.env.NODE_ENV === 'development', // только для dev/admin
	getJobOptions: async (input, request) => ({
		myJob: { apiKey: process.env.API_KEY },
	}),
});
```

## Правила

1. **Stateless handlers** — manager/storage передаются в factory
2. **Типизация** — `NextRequest`, `NextResponse`
3. **Error handling** — возвращай JSON с кодом ошибки
