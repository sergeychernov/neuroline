name: Publish to npm

on:
  push:
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Нужно для git diff HEAD~1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn build:packages

      - name: Initialize publish flags
        run: |
          echo "SKIP_PUBLISH=true" >> $GITHUB_ENV
          echo "SKIP_PUBLISH_UI=true" >> $GITHUB_ENV
          echo "SKIP_PUBLISH_NEXTJS=true" >> $GITHUB_ENV
          echo "SKIP_PUBLISH_NESTJS=true" >> $GITHUB_ENV

      - name: Auto-bump neuroline version if needed
        working-directory: packages/neuroline
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          # Проверяем, были ли изменения в src/ с последнего коммита
          if git diff HEAD~1 HEAD --quiet -- src/; then
            echo "Нет изменений в src/, пропускаем публикацию"
            echo "SKIP_PUBLISH=true" >> $GITHUB_ENV
          else
            echo "Обнаружены изменения в src/"
            # Проверяем, опубликована ли текущая версия
            if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
              echo "Версия $PACKAGE_VERSION уже опубликована, автоматически повышаем patch"
              # Вручную повышаем patch версию (npm version не работает с workspace:*)
              node -e "
                const fs = require('fs');
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                pkg.version = \`\${major}.\${minor}.\${patch + 1}\`;
                fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('Новая версия:', pkg.version);
              "
              echo "SKIP_PUBLISH=false" >> $GITHUB_ENV
            else
              echo "Версия $PACKAGE_VERSION не опубликована, можно публиковать"
              echo "SKIP_PUBLISH=false" >> $GITHUB_ENV
            fi
          fi

      - name: Publish neuroline
        if: env.SKIP_PUBLISH == 'false'
        working-directory: packages/neuroline
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Заменяем workspace:* на реальную версию ПОСЛЕ auto-bump neuroline
      - name: Prepare dependent packages for publish
        run: |
          NEUROLINE_VERSION=$(node -p "require('./packages/neuroline/package.json').version")
          echo "Используем версию neuroline: $NEUROLINE_VERSION"

          # Заменяем workspace:* на версию во всех зависимых пакетах
          for pkg in neuroline-nestjs neuroline-nextjs; do
            sed -i "s/\"neuroline\": \"workspace:\*\"/\"neuroline\": \"^$NEUROLINE_VERSION\"/g" packages/$pkg/package.json
          done

      - name: Auto-bump neuroline-ui version if needed
        working-directory: packages/neuroline-ui
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          if git diff HEAD~1 HEAD --quiet -- src/; then
            echo "Нет изменений в src/, пропускаем публикацию"
            echo "SKIP_PUBLISH_UI=true" >> $GITHUB_ENV
          else
            echo "Обнаружены изменения в src/"
            if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
              echo "Версия $PACKAGE_VERSION уже опубликована, автоматически повышаем patch"
              node -e "
                const fs = require('fs');
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                pkg.version = \`\${major}.\${minor}.\${patch + 1}\`;
                fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('Новая версия:', pkg.version);
              "
              echo "SKIP_PUBLISH_UI=false" >> $GITHUB_ENV
            else
              echo "Версия $PACKAGE_VERSION не опубликована, можно публиковать"
              echo "SKIP_PUBLISH_UI=false" >> $GITHUB_ENV
            fi
          fi

      - name: Publish neuroline-ui
        if: env.SKIP_PUBLISH_UI == 'false'
        working-directory: packages/neuroline-ui
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Auto-bump neuroline-nextjs version if needed
        working-directory: packages/neuroline-nextjs
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          # Проверяем изменения в src/ ИЛИ обновление neuroline
          NEED_PUBLISH=false

          if ! git diff HEAD~1 HEAD --quiet -- src/; then
            echo "Обнаружены изменения в src/"
            NEED_PUBLISH=true
          elif [ "$SKIP_PUBLISH" = "false" ]; then
            echo "neuroline был обновлён, нужно переопубликовать зависимый пакет"
            NEED_PUBLISH=true
          fi

          if [ "$NEED_PUBLISH" = "true" ]; then
            if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
              echo "Версия $PACKAGE_VERSION уже опубликована, автоматически повышаем patch"
              node -e "
                const fs = require('fs');
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                pkg.version = \`\${major}.\${minor}.\${patch + 1}\`;
                fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('Новая версия:', pkg.version);
              "
            else
              echo "Версия $PACKAGE_VERSION не опубликована, можно публиковать"
            fi
            echo "SKIP_PUBLISH_NEXTJS=false" >> $GITHUB_ENV
          else
            echo "Нет изменений, пропускаем публикацию"
          fi

      - name: Publish neuroline-nextjs
        if: env.SKIP_PUBLISH_NEXTJS == 'false'
        working-directory: packages/neuroline-nextjs
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Auto-bump neuroline-nestjs version if needed
        working-directory: packages/neuroline-nestjs
        run: |
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")

          # Проверяем изменения в src/ ИЛИ обновление neuroline
          NEED_PUBLISH=false

          if ! git diff HEAD~1 HEAD --quiet -- src/; then
            echo "Обнаружены изменения в src/"
            NEED_PUBLISH=true
          elif [ "$SKIP_PUBLISH" = "false" ]; then
            echo "neuroline был обновлён, нужно переопубликовать зависимый пакет"
            NEED_PUBLISH=true
          fi

          if [ "$NEED_PUBLISH" = "true" ]; then
            if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" version 2>/dev/null; then
              echo "Версия $PACKAGE_VERSION уже опубликована, автоматически повышаем patch"
              node -e "
                const fs = require('fs');
                const pkg = require('./package.json');
                const [major, minor, patch] = pkg.version.split('.').map(Number);
                pkg.version = \`\${major}.\${minor}.\${patch + 1}\`;
                fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
                console.log('Новая версия:', pkg.version);
              "
            else
              echo "Версия $PACKAGE_VERSION не опубликована, можно публиковать"
            fi
            echo "SKIP_PUBLISH_NESTJS=false" >> $GITHUB_ENV
          else
            echo "Нет изменений, пропускаем публикацию"
          fi

      - name: Publish neuroline-nestjs
        if: env.SKIP_PUBLISH_NESTJS == 'false'
        working-directory: packages/neuroline-nestjs
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
